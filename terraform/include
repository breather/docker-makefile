MAKEFLAGS       += --warn-undefined-variables
SHELL           := bash
.SHELLFLAGS     := -eu -o pipefail -c
.DEFAULT_GOAL   := help
.DELETE_ON_ERROR:
.SUFFIXES:


-include $(PWD)/.*.mk


#
# Default variable definitions meant to be overriden
#
AWS_PROFILE ?= $(WORKSPACE)
#WORKSPACE   ?= # must be defined in variable or included file


#
# Default command definitions
#
ASSUME          ?= $(ASSUME_CMD) $(AWS_PROFILE)
ASSUME_CMD      ?= assume-role

TERRAFORM       ?= $(ASSUME) $(TERRAFORM_CMD)
TERRAFORM_CMD   ?= terraform


#
# Default internal variables
#
CURRENT_WORKSPACE ?= $(shell cat .terraform/workspace 2> /dev/null || echo)
DEFAULT_WORKSPACE ?= default

CONFIG_DIR   ?= config
CONFIG_NAME  ?= $(WORKSPACE)

PLAN_PATH    ?= .terraform/plan.$(WORKSPACE)
SPACE_PATH   ?= .terraform/space.$(WORKSPACE)

STATE_BUCKET ?= terraform
STATE_TABLE  ?= terraform
STATE_PREFIX ?= workspace
STATE_REGION ?= us-east-1
#STATE_KEY    ?= # must be defined in variable or included file

#
# Bootstrap validation
#
ifeq ($(shell which $(ASSUME_CMD)),)
$(info Required command is not installed: $(ASSUME_CMD))
$(info - OSX     brew install remind101/formulae/assume-role)
$(info - Linux   visit https://github.com/remind101/assume-role/releases)
$(error Exiting)
endif

ifeq ($(shell which $(TERRAFORM_CMD)),)
	$(info Required command is not installed: $(TERRAFORM_CMD))
	$(info - OSX     brew install terraform)
	$(info - Linux   visit https://www.terraform.io/downloads.html)
	$(error Exiting)
endif

ifeq ($(strip $(CURRENT_WORKSPACE)),)
WORKSPACE ?= use1dev
else
WORKSPACE ?= $(CURRENT_WORKSPACE)
endif

WORKSPACE ?= DEFAULT_WORKSPACE

ifneq ($(CURRENT_WORKSPACE),$(WORKSPACE))
$(info active workspace has changed)
.terraform/workspace: clean
endif


#
# Targets
#
.PHONY: help
help:
	@echo Terraform make file
	@echo
	@echo Variables
	@printf "\033[36m%-20s\033[0m %s\n" AWS_PROFILE "aws profile to assume"
	@printf "\033[36m%-20s\033[0m %s\n" "- current" "  $(AWS_PROFILE)"
	@printf "\033[36m%-20s\033[0m %s\n" "- default" "  WORKSPACE"
	@printf "\033[36m%-20s\033[0m %s\n" WORKSPACE "environment to target"
	@printf "\033[36m%-20s\033[0m %s\n" "- current" "  $(WORKSPACE)"
	@printf "\033[36m%-20s\033[0m %s\n" "- allowed" "  use1dev or use1prod"
	@printf "\033[36m%-20s\033[0m %s\n" STATE_KEY "terraform state path"
	@printf "\033[36m%-20s\033[0m %s\n" "- current" "  $(STATE_KEY)"
	@echo
	@echo Targets:
	@grep -hE '^[a-zA-Z_\-\.]+(.%)?:.*?## .*$$' $(MAKEFILE_LIST) | \
		sort | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'


.PHONY: .FORCE
.FORCE: # Dummy target used to force run


.PHONY: all
all: apply

.PHONY: apply
apply: $(PLAN_PATH) ## Builds or changes infrastructure
	$(TERRAFORM) apply \
	-parallelism=80 \
	$(PLAN_PATH)
	@make clean

.PHONY: check
check: format validate ## Lints and validates terraform files

.PHONY: clean
clean: ## Cleans the working environment of temporary files
	rm -f .terraform/plan.*
	rm -f .terraform/space.*

.PHONY: destroy
destroy: ## Destroy Terraform-managed infrastructure
	$(TERRAFORM) destroy \
	-var-file $(CONFIG_DIR)/default.tfvars \
	-var-file $(CONFIG_DIR)/$(CONFIG_NAME).tfvars

.PHONY: format
format: ## Rewrites config files to canonical format
	$(TERRAFORM_CMD) fmt

.PHONY: init
init: $(STATE_PATH) ## Initialize terraform's state file

inspect.%: .FORCE ## Inspects the value of variable within Makefile
	@echo $($*)

.PHONY: list
list: ## List resource identifiers found within state file
	$(TERRAFORM) state list

.PHONY: output
output: ## Read all output from a state file
	$(TERRAFORM) output

output.%: ## Read an output from a state file
	$(TERRAFORM) output -module=$*

.PHONY: plan ## Generate and show an execution plan
plan: clean .terraform/workspace update check $(PLAN_PATH)

.PHONY: reset
reset: clean ## Reset terraform temporary files
	@rm -fr .terraform

.PHONY: show
show: ## Inspect Terraform state or plan
	@$(TERRAFORM) show $(PLAN_PATH)

show.%: .FORCE ## Show a resource in the state
	@$(TERRAFORM) state show $*

.PHONY: update
update: ## Download and install modules for the configuration
	$(TERRAFORM_CMD) get -update=true > /dev/null

.PHONY: validate
validate: ## Validates the Terraform files
	$(TERRAFORM_CMD) validate \
	-var-file $(CONFIG_DIR)/default.tfvars \
	-var-file $(CONFIG_DIR)/$(CONFIG_NAME).tfvars

.PHONY: workspace
workspace: clean .terraform/workspace ## Switches the active workspace to WORKSPACE

.terraform/workspace: $(SPACE_PATH)
	@echo $(WORKSPACE) > .terraform/workspace;
	$(TERRAFORM) workspace select $(WORKSPACE);
	$(eval CURRENT_WORKSPACE=$(WORKSPACE))

.terraform/space.%: .terraform/terraform.tfstate
	@if ! $(TERRAFORM) workspace list | grep -q $*; then \
		$(TERRAFORM) workspace new $*; \
	fi; \
	touch .terraform/space.$*; \

.terraform/terraform.tfstate:
	$(TERRAFORM) init \
	-backend-config="acl=private" \
	-backend-config="bucket=$(STATE_BUCKET)" \
	-backend-config="dynamodb_table=$(STATE_TABLE)" \
	-backend-config="key=$(STATE_KEY)" \
	-backend-config="region=$(STATE_REGION)" \
	-backend-config="workspace_key_prefix=$(STATE_PREFIX)" \
	-force-copy \
	-input=false

.terraform/plan.%: .terraform/workspace
	$(TERRAFORM) plan \
	-module-depth=-1 \
	-out .terraform/plan.$* \
	-parallelism=80 \
	-refresh=true \
	-var-file $(CONFIG_DIR)/default.tfvars \
	-var-file $(CONFIG_DIR)/$(CONFIG_NAME).tfvars

#  vim: set ft=make ts=2 sw=2 noet :
